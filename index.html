
<!DOCTYPE html>
<html>
    <meta name="viewport" content="width=device-width, maximum-scale=1.0, user-scalable=0">
   <link rel="stylesheet" href="/assets/themes//css/bootstrap.min.css" media="screen and (min-device-width: 700px)"/>
   <link rel="stylesheet" href="/assets/themes//css/pygments.css" />
   <link rel="stylesheet" href="/assets/themes//css/style.css" media="screen"/>
   <link rel="stylesheet" href="/assets/themes//css/mobile.css" media="handheld"/>
   <script type="text/javascript" charset="utf-8" async="" src="/assets/themes//js/common.js"></script>

   <header>
       <meta charset="utf-8">
       <meta charset="UTF-8"/>
       
       
       <title>Yukang's Page</title>
       

       
       <meta name="author" content="Yukang">

       <script type="text/javascript"
               href="/assets/themes/twitter/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
       </script>

       <!-- Le fav and touch icons -->
       <link rel="shortcut icon" href="/images/favicon.ico">
       <div class="navbar" id="navbar">
           <div class="navbar-inner">
        <div class="container">
          <a class="brand" id="brand" href="/">Yukang's Page</a>
          <ul class="nav" id="navbar-inner">
            
            
            


  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
      	
      	<li><a href="/archive">归档</a></li>
      	
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
      	
      	<li><a href="/tags">标签</a></li>
      	
      
    
  




            <li class="divider-vertical"></li>
            <li><a href="/about.html">关于</a></li>
            <li><a href="/links.html">链接</a></li>
            <li><a href="/atom.xml">订阅</a></li>
          </ul>
          <span class="pull-right slogan"> Don't Panic </span>
        </div>
      </div>
    </div>
  </header>

  <body>
      <div class="container">
      <div class="content" >
        


<div class="row post">
  <div class="span8">
      <h1 class="title"><a href="/2017/07/16/kong-intro-3.html" title="Kong原理分析: 插件">Kong原理分析: 插件</a></h1>

      <h3>插件的强大之处</h3>

<p>在我自己使用 Kong 的过程中，最方便的还是在于 Kong 的强大的插件机制。 Nginx 本身提供了提供模块开发机制，但是相对来说更底层一些，并且需要使用 C/C++ 来开发，对于很多开发人员来说 Nginx 仍为一个黑盒。OpenResty 集成了很多好用插件，并提供了通过 Lua 扩展 Nginx 的机制，所以 OpenResty 相对来说更灵活。而 Kong 在 OpenResty 基础上提供的插件机制更灵活，在于： </p>
<div class="highlight"><pre><code class="language-text" data-lang="text"><span></span>复用：OpenResty 的复用在于函数级别，我们可以把一些通用的 Lua 函数引入各个项目。而 Kong 的插件复用可以通过 API 修改一下配置即可。是否启用某个插件，这只是数据配置问题，启用与否不会涉及到代码的改动。

抽象、统一: Kong 实现了基础的插件配置的存储和更新机制，所以我们只需按照要求定义插件配置的数据类型，插件实现的时候不用再去关心这些细节。

灵活、组合: OpenResty 的一些处理部分有限制，比如 access_by_lua 在同一个 location 能调用一次， 当然我们可以把多个处理逻辑都放在这里，这又涉及到代码改动。 而 Kong 可以依次调用各个插件对应的 phase，并且通过引入优先级来解决前后顺序问题。
</code></pre></div>
<p>对于插件这块我们的疑问在于这套机制如何运行的？如何找到站点对应的插件？如此多的插件是否会有性能问题？</p>

<h3>Kong插件的运行机制</h3>

<p>在上一文 Kong 初始化分析中，我们看到 nginx_kong.lua 模板文件里面有这么一段代码：</p>

<figure class="highlight"><pre><code class="language-lua" data-lang="lua"><span></span><span class="n">location</span> <span class="o">/</span> <span class="p">{</span> 
  <span class="n">rewrite_by_lua_block</span> <span class="p">{</span>
      <span class="n">kong</span><span class="p">.</span><span class="n">rewrite</span><span class="p">()</span>
  <span class="p">}</span>

  <span class="n">access_by_lua_block</span> <span class="p">{</span>
      <span class="n">kong</span><span class="p">.</span><span class="n">access</span><span class="p">()</span>
  <span class="p">}</span>

  <span class="n">header_filter_by_lua_block</span> <span class="p">{</span>
      <span class="n">kong</span><span class="p">.</span><span class="n">header_filter</span><span class="p">()</span>
  <span class="p">}</span>

  <span class="n">body_filter_by_lua_block</span> <span class="p">{</span>
      <span class="n">kong</span><span class="p">.</span><span class="n">body_filter</span><span class="p">()</span>
  <span class="p">}</span>

  <span class="n">log_by_lua_block</span> <span class="p">{</span>
      <span class="n">kong</span><span class="p">.</span><span class="n">log</span><span class="p">()</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p>在 kong.lua 文件里面， kong.access 的实现是这样的:</p>

<figure class="highlight"><pre><code class="language-lua" data-lang="lua"><span></span><span class="kr">function</span> <span class="nc">Kong</span><span class="p">.</span><span class="nf">access</span><span class="p">()</span>
  <span class="n">core</span><span class="p">.</span><span class="n">access</span><span class="p">.</span><span class="n">before</span><span class="p">()</span>

  <span class="kr">for</span> <span class="n">plugin</span><span class="p">,</span> <span class="n">plugin_conf</span> <span class="kr">in</span> 
      <span class="n">plugins_iterator</span><span class="p">(</span><span class="n">singletons</span><span class="p">.</span><span class="n">loaded_plugins</span><span class="p">,</span> <span class="kc">true</span><span class="p">)</span> <span class="kr">do</span>
    <span class="n">plugin</span><span class="p">.</span><span class="n">handler</span><span class="p">:</span><span class="n">access</span><span class="p">(</span><span class="n">plugin_conf</span><span class="p">)</span>
  <span class="kr">end</span>

  <span class="n">core</span><span class="p">.</span><span class="n">access</span><span class="p">.</span><span class="n">after</span><span class="p">()</span>
<span class="kr">end</span></code></pre></figure>

<p>从这里可以看出 Kong 的插件运行机制就是从 loaded_plugins 里面依次执行。 学习 Kong 插件开发的方法是参考现有的一些插件实现，学着写几个就会了。用户自己定义的插件是在 base_plugin 基类上继承而来。Kong 里面使用的了<a href="https://github.com/rxi/classic"> 这套 class 机制</a>，可以看到使用 Lua 实现面向对象还是很简单的。</p>

<h3>singletons.loaded_plugins</h3>

<p><a href="https://github.com/chenyukang/kong/blob/blog-ref/kong/kong.lua#L156">singletons.loaded_plugins</a>在这里初始化的，在具体<a href="https://github.com/chenyukang/kong/blob/blog-ref/kong/kong.lua#L70">实现过程中</a>就是从数据库里面把插件配置读出，</p>

<figure class="highlight"><pre><code class="language-lua" data-lang="lua"><span></span><span class="kd">local</span> <span class="n">ok</span><span class="p">,</span> <span class="n">handler</span> <span class="o">=</span> <span class="n">utils</span><span class="p">.</span><span class="n">load_module_if_exists</span><span class="p">(</span><span class="s2">&quot;kong.plugins.&quot;</span> <span class="o">..</span> <span class="n">plugin</span> <span class="o">..</span> <span class="s2">&quot;.handler&quot;</span><span class="p">)</span></code></pre></figure>

<p>在每一个插件在 handler.lua 的最后都是 return XXXXHandler，所以在调用 <a href="https://github.com/chenyukang/kong/blob/blog-ref/kong/kong.lua#L105">handler()</a>后我们在内存中导入了插件的对象。另外在初始化后需要<a href="https://github.com/chenyukang/kong/blob/blog-ref/kong/kong.lua#L116">按照优先级来排序</a>，以此来保证各个插件之间的执行顺序。</p>

<p>从上面的分析上看出，插件导入后都会在内存中的全局对象中存储，后面的开销在于依次迭代插件。</p>

<h3>plugins_iterator</h3>

<p>我们再来看看某个站点是否启用某个插件是如何处理的，最主要的实现在于 plugins_iterator 这个函数。首先我们得理解如何确定当前 request 对应的唯一标识符， 在<a href="https://github.com/chenyukang/kong/blob/blog-ref/kong/core/handler.lua#L128">core.handler.access</a>的过程中保存了经过路由后的 api在ngx.ctx 里，这个 ngx.ctx 会在整个request 处理过程中反复被使用。再回到 plugins_interator 函数，这个函数的参数有两个，后一个叫access_or_cert_ctx， 因为对于一个 request处理中 plugins_iterator 会调用多次，这个参数的作用在于判断是否是第一个调用这个函数。第一次调用可能发生在<a href="https://github.com/chenyukang/kong/blob/blog-ref/kong/kong.lua#L219">ssl_certificate</a>或者<a href="https://github.com/chenyukang/kong/blob/blog-ref/kong/kong.lua#L297">access</a> 阶段， 因为在 ctx 里面 Kong 还是初始化了一个叫做<code>ctx.plugins_for_request</code>的变量来存储当前 request 启用的插件，这样后续 iterator 阶段就完全不会去重复 load 插件配置，这样做当然是为了性能上的考虑。</p>

<p>读取插件配置的函数调用是： </p>

<figure class="highlight"><pre><code class="language-lua" data-lang="lua"><span></span><span class="kr">if</span> <span class="n">api</span> <span class="kr">then</span>
   <span class="n">plugin_configuration</span> <span class="o">=</span> <span class="n">load_plugin_configuration</span><span class="p">(</span><span class="n">api</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">consumer_id</span><span class="p">,</span> <span class="n">plugin</span><span class="p">.</span><span class="n">name</span><span class="p">)</span>
<span class="kr">end</span></code></pre></figure>

<p><a href="https://github.com/chenyukang/kong/blob/blog-ref/kong/core/plugins_iterator.lua#L38">load_plugin_configuration</a>也会首先尝试从内存缓存中取，如果取不到再从数据库中取出，然后存储在缓存中。</p>

<p>从上面的分析看出，插件相关的读取和执行在大部分时间里是完全不会去读数据库的，所以性能损失并不会大。</p>

<h3>错误处理</h3>

<p>Kong的插件部分并没有错误处理部分，从现有代码上看错误处理分两个部分:</p>

<p>一种方式是<a href="https://github.com/chenyukang/kong/blob/blog-ref/kong/tools/responses.lua">responses.lua</a>， 如果是在 Kong 的 Lua 代码部分检查出来的错误一般使用类似<a href="https://github.com/chenyukang/kong/blob/blog-ref/kong/kong.lua#L250">responses.send(500)</a>这样的方式来向客户端返回错误码。</p>

<p>第二种是通过 <a href="https://github.com/chenyukang/kong/blob/blog-ref/kong/templates/nginx_kong.lua#L81">kong_error_handler</a>。 这种错误可能是执行了 ngx.exit(500) 之类的代码或者是 Nginx 内部触发的。</p>

<p>这在某些情况下对用户不友好，我们不能只简单地返回一个错误信息，有的时候我们需要展示一个漂亮些的错误页面或者是把请求转到别的降级站点，对于这个需求我做了<a href="https://github.com/chenyukang/kong/tree/custom-error-handle">一个分支来扩展错误处理</a>。 目前实现还未完整，不过已经可以定制化错误页面了。 这里增加了一个 <a href="https://github.com/chenyukang/kong/blob/custom-error-handle/kong/templates/nginx_kong.lua#L113">ngx.var.api_id</a>，这个变量的初始化也在 <a href="https://github.com/chenyukang/kong/blob/60c934c851f41dfd6a921995a2568905284af742/kong/core/handler.lua#L98">core.access 阶段</a>。因为存储在 ngx.ctx 里的这些信息在执行了 ngx.exit 之后已经释放了，所以我需要一个 ngx.var 级别的变量存储 api_id，然后使用这个变量来判断 error-handler 插件是否启用。</p>


      <div style="padding: 10px 0; margin: 20px auto; width: 90%; text-align: center;">          
      <button id="rewardButton" disable="enable" onclick="var qr = document.getElementById('QR'); if (qr.style.display === 'none') {qr.style.display='block';} else {qr.style.display='none'}">
      <span>打赏</span>
      </button>
      <div id="QR" style="display: none;">      
      <div id="wechat" style="display: inline-block">
      <a href="/images/yukang_wechat.jpg" rel="group" ><img id="wechat_qr" src="/images/yukang_wechat.jpg" style="width: 255px;height:235px;"  alt="Yukang WeChat Pay"></a>
      </div>
      </div>
      </div>


    <ul class="pager">
        <li class="previous"><a href="#comment_thread" title="Kong原理分析: 插件">评论&darr;</a></li>
      <li class="next"><a href="/archive.html" title="所有文章">查看所有文章 &rarr;</a></li>
    </ul>


    <!--*********************************************************-->
    <!--****** 看见这个时候，删掉下面的统计代码啊~ ******-->
    <!--*********************************************************-->
    <div id="disqus_thread"></div>
    <script>

    /**
    *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
    *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables*/
    /*
    var disqus_config = function () {
    this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
    this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
    };
    */
    (function() { // DON'T EDIT BELOW THIS LINE
    var d = document, s = d.createElement('script');
    s.src = 'https://yukang.disqus.com/embed.js';
    s.setAttribute('data-timestamp', +new Date());
    (d.head || d.body).appendChild(s);
    })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    
    <!--*********************************************************-->
    
  </div>

  <div class="span4 sidebar">
    <h4 class="date">日期：<span>16 July 2017</span></h4>
    

    <div class="violet-aside-post">
      <h4 class="v-section-tit">最近</h4>
      <ul>
        
        <li class="v-aside-li">
          <a href="/2017/07/16/kong-intro-3.html" title="Kong原理分析: 插件" rel="bookmark">Kong原理分析: 插件</a>
        </li>
        
        <li class="v-aside-li">
          <a href="/2017/07/07/kong-intro-2.html" title="Kong原理分析: 启动" rel="bookmark">Kong原理分析: 启动</a>
        </li>
        
        <li class="v-aside-li">
          <a href="/2017/07/02/kong-intro.html" title="Kong原理分析" rel="bookmark">Kong原理分析</a>
        </li>
        
        <li class="v-aside-li">
          <a href="/2017/06/27/recent-reading-list.html" title="小说推荐" rel="bookmark">小说推荐</a>
        </li>
        
        <li class="v-aside-li">
          <a href="/2017/05/22/try-on-openresty.html" title="OpenResty使用总结" rel="bookmark">OpenResty使用总结</a>
        </li>
        
        <li class="v-aside-li">
          <a href="/2017/04/09/rubytt-cont.html" title="rubytt 续" rel="bookmark">rubytt 续</a>
        </li>
        
        <li class="v-aside-li">
          <a href="/2017/01/24/disease-of-programmer.html" title="程序员病" rel="bookmark">程序员病</a>
        </li>
        
        <li class="v-aside-li">
          <a href="/2016/12/27/rubytt.html" title="Ruby 程序的静态分析: rubytt" rel="bookmark">Ruby 程序的静态分析: rubytt</a>
        </li>
        
        <li class="v-aside-li">
          <a href="/2016/12/11/qianlong-history.html" title="读《饥饿的盛世》" rel="bookmark">读《饥饿的盛世》</a>
        </li>
        
        <li class="v-aside-li">
          <a href="/2016/11/30/nginx-traffic-limit.html" title="Nginx限流" rel="bookmark">Nginx限流</a>
        </li>
        
        <li class="v-aside-li">
          <a href="/2016/08/09/dao-yu-ju.html" title="菊与刀" rel="bookmark">菊与刀</a>
        </li>
        
        <li class="v-aside-li">
          <a href="/2016/07/22/capistrano-syntax-check-for-rails.html" title="Add syntax check for Capistrano" rel="bookmark">Add syntax check for Capistrano</a>
        </li>
        
        <li class="v-aside-li">
          <a href="/2016/07/08/fun-on-hackerrank.html" title="刷刷算法和 OJ" rel="bookmark">刷刷算法和 OJ</a>
        </li>
        
        <li class="v-aside-li">
          <a href="/2015/09/29/programming-language-and-interpreters.html" title="Tiny Interpreters" rel="bookmark">Tiny Interpreters</a>
        </li>
        
        <li class="v-aside-li">
          <a href="/2015/08/09/reading-notes.html" title="最近读的一些杂书" rel="bookmark">最近读的一些杂书</a>
        </li>
        
      </ul>
    </div>

    <div class="violet-aside-post">
      <h4 class="v-section-tit">页面</h4>
    <nav class="nav">
      <ul>
        <li><a href="/archive.html" >归档</a></li>
        <li><a href="/tags.html">标签</a></li>
        <li><a href="/links.html" >链接</a></li>
        <li><a href="/about.html" >关于</a></li>
        <li><a href="/atom.xml" target="_blank" >RSS</a></li>
      </ul>
    </nav>
    </div>

  </div>
</div>



      </div>

      <footer id="footer">
        <p>&copy; <a href="mailto:moorekang@gmail.com">Yukang</a> 2016.
          Proudly powered by <a href="http://jekyllbootstrap.com" target="_blank" title="The Definitive Jekyll Blogging Framework">Jekyll</a>
        </p>

      </footer>
    </div> <!-- /container -->

    <!--*********************************************************-->
    <!--****** 看见这个时候，删掉下面的统计代码啊~ ******-->
    <!--*********************************************************-->
    
    <script>
     var _hmt = _hmt || [];
     (function() {
         var hm = document.createElement("script");
         hm.src = "//hm.baidu.com/hm.js?ba1315646a61cc7bd6f574a6b5221640";
         var s = document.getElementsByTagName("script")[0]; 
         s.parentNode.insertBefore(hm, s);
     })();

     (function() {
         var width = document.body.offsetWidth;
         if(width < 701) {
             var nav = document.getElementById("navbar-inner");
             nav.remove();
         };
     })();
    </script>

    <!--*********************************************************-->

  </body>
  
</html>

